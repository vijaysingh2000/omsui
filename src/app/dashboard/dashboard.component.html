<div class="container-fluid py-4">

  <!-- Filter Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white fw-semibold d-flex justify-content-between align-items-center">
      <span>Orders In Progress</span>
      <a routerLink="/reports" class="btn btn-sm btn-outline-light">Reports →</a>
    </div>
    <div class="card-body">
      <form (ngSubmit)="submit()" #filterForm="ngForm">
        <div class="row g-3 align-items-end">

          <!-- Client Selector -->
          <div class="col-12 col-md-3">
            <label for="clientSelect" class="form-label fw-semibold">Client</label>
            <select id="clientSelect" class="form-select" name="clientSelect"
                    [(ngModel)]="selectedClientId"
                    [disabled]="clientsLoading">
              <option [ngValue]="undefined">
                @if (clientsLoading) { Loading... } @else { — All Clients — }
              </option>
              @for (c of clients; track c.id) {
                <option [ngValue]="c.id">{{ c.name }}</option>
              }
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label for="dateRange" class="form-label fw-semibold">Date Range</label>
            <select id="dateRange" class="form-select" name="dateRange" [(ngModel)]="selectedDateRangeKey">
              @for (opt of dateRangeOptions; track opt.key) {
                <option [ngValue]="opt.key">{{ opt.label }} ({{ dateRangeLabel(opt.key) }})</option>
              }
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label for="dashboardView" class="form-label fw-semibold">Dashboard View</label>
            <select id="dashboardView" class="form-select" name="dashboardView" [(ngModel)]="selectedDashboardView">
              @for (opt of dashboardViewOptions; track opt.value) {
                <option [ngValue]="opt.value">{{ opt.label }}</option>
              }
            </select>
          </div>

          <div class="col-12 col-md-3 d-grid">
            <button type="submit" class="btn btn-primary" [disabled]="loading">
              @if (loading) {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading...
              } @else {
                Search
              }
            </button>
          </div>

        </div>
      </form>
    </div>
  </div>

  <!-- Error Alert -->
  @if (errorMsg) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {{ errorMsg }}
      <button type="button" class="btn-close" (click)="errorMsg = null" aria-label="Close"></button>
    </div>
  }

  <!-- Results Card -->
  @if (submitted && !loading) {
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Results</span>
        <span class="badge bg-secondary">{{ results.length }} record(s)</span>
      </div>

      @if (results.length === 0) {
        <div class="card-body text-center text-muted py-5">
          <p class="mb-0">No records found for the selected criteria.</p>
        </div>
      } @else {
        <!-- Summary Badges -->
        <div class="card-body border-bottom pb-3">
          <div class="row g-3">
            <div class="col-auto">
              <span class="badge text-bg-primary fs-6 px-3 py-2">
                Billed: {{ totalAmountBilled | currency }}
              </span>
            </div>
            <div class="col-auto">
              <span class="badge text-bg-success fs-6 px-3 py-2">
                Payments: {{ totalPayments | currency }}
              </span>
            </div>
            <div class="col-auto">
              <span class="badge text-bg-warning text-dark fs-6 px-3 py-2">
                Balance: {{ totalBalance | currency }}
              </span>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-hover table-bordered mb-0 align-middle">
            <thead class="table-dark">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Order #</th>
                <th scope="col">Patient</th>
                <th scope="col">MRN</th>
                <th scope="col">Drug</th>
                <th scope="col">DOS</th>
                <th scope="col">Est. Delivery</th>
                <th scope="col">Insurance</th>
                <th scope="col">Task</th>
                <th scope="col" class="text-end">Units Billed</th>
                <th scope="col" class="text-end">Amount Billed</th>
                <th scope="col" class="text-end">Payments</th>
                <th scope="col" class="text-end">Balance</th>
                <th scope="col" class="text-center">Billed?</th>
              </tr>
            </thead>

            <tbody>
              @for (row of results; track row.orderId; let i = $index) {
                <tr>
                  <td class="text-muted small">{{ i + 1 }}</td>
                  <td class="fw-semibold">{{ row.orderNumber ?? '—' }}</td>
                  <td>{{ row.patientName ?? '—' }}</td>
                  <td class="text-muted small">{{ row.mrn ?? '—' }}</td>
                  <td>{{ row.drugName ?? '—' }}</td>
                  <td class="small">{{ row.dos ? (row.dos | date:'MM/dd/yyyy') : '—' }}</td>
                  <td class="small">{{ row.estimatedDeliveryDate ? (row.estimatedDeliveryDate | date:'MM/dd/yyyy') : '—' }}</td>
                  <td>{{ row.insuranceName ?? '—' }}</td>
                  <td>
                    @if (row.currentTaskCode) {
                      <span class="badge text-bg-info">{{ row.currentTaskCode }}</span>
                    } @else {
                      <span class="text-muted">—</span>
                    }
                  </td>
                  <td class="text-end">{{ row.totalUnitsBilled ?? 0 }}</td>
                  <td class="text-end">{{ row.totalAmountBilled | currency }}</td>
                  <td class="text-end text-success fw-semibold">{{ row.totalPayments | currency }}</td>
                  <td class="text-end" [class.text-danger]="(row.totalBalance ?? 0) > 0" [class.text-success]="(row.totalBalance ?? 0) <= 0">
                    {{ row.totalBalance | currency }}
                  </td>
                  <td class="text-center">
                    @if (row.isBilled) {
                      <span class="badge text-bg-success">Yes</span>
                    } @else {
                      <span class="badge text-bg-secondary">No</span>
                    }
                  </td>
                </tr>
              }
            </tbody>

            <tfoot class="table-dark fw-bold">
              <tr>
                <td colspan="10" class="text-end">Totals</td>
                <td class="text-end">{{ totalAmountBilled | currency }}</td>
                <td class="text-end text-success">{{ totalPayments | currency }}</td>
                <td class="text-end" [class.text-danger]="totalBalance > 0">{{ totalBalance | currency }}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      }
    </div>
  }

</div>
