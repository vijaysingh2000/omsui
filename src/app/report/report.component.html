<div class="container-fluid py-4">

  <!-- Filter Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-secondary text-white fw-semibold d-flex justify-content-between align-items-center">
      <span>Reports</span>
      <a routerLink="/dashboard" class="btn btn-sm btn-outline-light">← Back to Dashboard</a>
    </div>
    <div class="card-body">
      <form (ngSubmit)="submit()" #filterForm="ngForm">
        <div class="row g-3 align-items-end">

          <!-- Report Selector -->
          <div class="col-12 col-md-5">
            <label for="reportSelect" class="form-label fw-semibold">Report</label>
            <select id="reportSelect" class="form-select" name="reportSelect" [(ngModel)]="selectedReportKey" [disabled]="reportsLoading">
              @if (reportsLoading) {
                <option value="">Loading reports...</option>
              } @else {
                @for (r of dropdownItems; track r.key) {
                  <option [ngValue]="r.key">{{ r.label }}</option>
                }
              }
            </select>
          </div>

          <!-- Start Date -->
          <div class="col-12 col-md-2">
            <label for="startDate" class="form-label fw-semibold">Start Date</label>
            <input
              id="startDate"
              type="date"
              class="form-control"
              name="startDate"
              [(ngModel)]="startDate"
              required />
          </div>

          <!-- End Date -->
          <div class="col-12 col-md-2">
            <label for="endDate" class="form-label fw-semibold">End Date</label>
            <input
              id="endDate"
              type="date"
              class="form-control"
              name="endDate"
              [(ngModel)]="endDate"
              required />
          </div>

          <!-- Submit -->
          <div class="col-12 col-md-3 d-grid">
            <button type="submit" class="btn btn-secondary" [disabled]="loading || filterForm.invalid">
              @if (loading) {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading...
              } @else {
                Run Report
              }
            </button>
          </div>

        </div>
      </form>
    </div>
  </div>

  <!-- Error Alert -->
  @if (errorMsg) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {{ errorMsg }}
      <button type="button" class="btn-close" (click)="errorMsg = null" aria-label="Close"></button>
    </div>
  }

  <!-- Results -->
  @if (submitted && !loading) {
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">{{ displayedReport?.label }}</span>
        <span class="badge bg-secondary">{{ results.length }} record(s)</span>
      </div>

      @if (results.length === 0) {
        <div class="card-body text-center text-muted py-5">
          No records found for the selected criteria.
        </div>
      } @else {
        <div class="report-table-wrapper">
          <table class="table table-hover table-striped table-bordered mb-0 align-middle small">
            <thead class="table-dark report-sticky-head">
              <tr>
                <th>#</th>
                @for (col of displayedReport!.columns; track col.field) {
                  <th [class.text-end]="col.type === 'currency' || col.type === 'number'">
                    {{ col.header }}
                  </th>
                }
              </tr>
            </thead>

            <tbody>
              @for (row of results; track $index; let i = $index) {
                <tr>
                  <td class="text-muted">{{ i + 1 }}</td>
                  @for (col of displayedReport!.columns; track col.field) {
                    @if (col.type === 'badge') {
                      <td>
                        @if (row[col.field]) {
                          <span class="badge text-bg-info">{{ row[col.field] }}</span>
                        } @else {
                          <span class="text-muted">—</span>
                        }
                      </td>
                    } @else if (col.type === 'currency') {
                      <td class="text-end"
                          [class.text-danger]="col.field === 'totalBalance' && (row[col.field] ?? 0) > 0"
                          [class.text-success]="col.field === 'totalBalance' && (row[col.field] ?? 0) <= 0">
                        {{ formatCell(row[col.field], 'currency') }}
                      </td>
                    } @else if (col.type === 'number') {
                      <td class="text-end">{{ formatCell(row[col.field], 'number') }}</td>
                    } @else {
                      <td>{{ formatCell(row[col.field], col.type) }}</td>
                    }
                  }
                </tr>
              }
            </tbody>

            <!-- Totals footer — only shown when there are currency columns -->
            @if (currencyFields().length > 0) {
              <tfoot class="table-dark fw-bold">
                <tr>
                  <td></td>
                  @for (col of displayedReport!.columns; track col.field) {
                    @if (col.type === 'currency') {
                      <td class="text-end">{{ columnTotal(col.field) | currency }}</td>
                    } @else {
                      <td></td>
                    }
                  }
                </tr>
              </tfoot>
            }
          </table>
        </div>
      }
    </div>
  }

</div>
