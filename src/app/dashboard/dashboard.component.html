<div class="oms-shell">

  <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <aside class="oms-sidebar">
    <div class="sidebar-brand">
      <span class="brand-icon">‚öï</span>
      <span class="brand-text">OMS</span>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-link" routerLink="/dashboard" routerLinkActive="active" [routerLinkActiveOptions]="{exact:true}">
        <span class="link-icon">üìä</span> Dashboard
      </a>
      <a class="sidebar-link" routerLink="/patients" routerLinkActive="active">
        <span class="link-icon">üßë‚Äç‚öïÔ∏è</span> Patients
      </a>
      <a class="sidebar-link" routerLink="/call-list" routerLinkActive="active">
        <span class="link-icon">üìû</span> Call List
      </a>
      <a class="sidebar-link" routerLink="/list" routerLinkActive="active">
        <span class="link-icon">üìã</span> List
      </a>
      <a class="sidebar-link" routerLink="/batch-payment" routerLinkActive="active">
        <span class="link-icon">üí≥</span> Batch Payment
      </a>
      <a class="sidebar-link" routerLink="/invoices" routerLinkActive="active">
        <span class="link-icon">üßæ</span> Invoices
      </a>
      <a class="sidebar-link" routerLink="/users" routerLinkActive="active">
        <span class="link-icon">üë•</span> Users
      </a>
      <a class="sidebar-link" routerLink="/reports" routerLinkActive="active">
        <span class="link-icon">üìà</span> Reports
      </a>
    </nav>

    <div class="sidebar-footer">
      <a class="sidebar-link" routerLink="/my-profile" routerLinkActive="active">
        <span class="link-icon">üë§</span> My Profile
      </a>      <button class="sidebar-link sidebar-logout" (click)="logout()">
        <span class="link-icon">&#x1F6AA;</span> Logout
      </button>    </div>
  </aside>

  <!-- ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <main class="oms-main">

    <!-- KPI Cards -->
    @if (submitted && !loading && results.length > 0) {
      <div class="row g-3 mb-4">
        <div class="col-12 col-sm-4">
          <div class="kpi-card kpi-blue">
            <div class="kpi-label">Total Billed</div>
            <div class="kpi-value">{{ totalAmountBilled | currency }}</div>
            <div class="kpi-icon">üí∞</div>
          </div>
        </div>
        <div class="col-12 col-sm-4">
          <div class="kpi-card kpi-green">
            <div class="kpi-label">Total Payments</div>
            <div class="kpi-value">{{ totalPayments | currency }}</div>
            <div class="kpi-icon">‚úÖ</div>
          </div>
        </div>
        <div class="col-12 col-sm-4">
          <div class="kpi-card" [class.kpi-red]="totalBalance > 0" [class.kpi-green]="totalBalance <= 0">
            <div class="kpi-label">Outstanding Balance</div>
            <div class="kpi-value">{{ totalBalance | currency }}</div>
            <div class="kpi-icon">‚öñÔ∏è</div>
          </div>
        </div>
      </div>
    }

    <!-- Filter Card -->
    <div class="oms-card mb-4">
      <div class="oms-card-header">
        <span>üîç Filter Orders</span>
      </div>
      <div class="oms-card-body">
        <form (ngSubmit)="submit()" #filterForm="ngForm">
          <div class="row g-3 align-items-end">

            <div class="col-12 col-md-3">
              <label for="clientSelect" class="form-label fw-semibold small text-uppercase text-muted letter-spacing">Client</label>
              <select id="clientSelect" class="form-select form-select-sm" name="clientSelect"
                      [(ngModel)]="selectedClientId" [disabled]="clientsLoading">
                <option [ngValue]="undefined">
                  @if (clientsLoading) { Loading... } @else { ‚Äî All Clients ‚Äî }
                </option>
                @for (c of clients; track c.id) {
                  <option [ngValue]="c.id">{{ c.name }}</option>
                }
              </select>
            </div>

            <div class="col-12 col-md-3">
              <label for="dateRange" class="form-label fw-semibold small text-uppercase text-muted letter-spacing">Date Range</label>
              <select id="dateRange" class="form-select form-select-sm" name="dateRange" [(ngModel)]="selectedDateRangeKey">
                @for (opt of dateRangeOptions; track opt.key) {
                  <option [ngValue]="opt.key">{{ opt.label }} ({{ dateRangeLabel(opt.key) }})</option>
                }
              </select>
            </div>

            <div class="col-12 col-md-3">
              <label for="dashboardView" class="form-label fw-semibold small text-uppercase text-muted letter-spacing">View</label>
              <select id="dashboardView" class="form-select form-select-sm" name="dashboardView" [(ngModel)]="selectedDashboardView">
                @for (opt of dashboardViewOptions; track opt.value) {
                  <option [ngValue]="opt.value">{{ opt.label }}</option>
                }
              </select>
            </div>

            <div class="col-12 col-md-3 d-grid">
              <button type="submit" class="btn btn-primary btn-sm" [disabled]="loading">
                @if (loading) {
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Loading...
                } @else {
                  üîç Search
                }
              </button>
            </div>

          </div>
        </form>
      </div>
    </div>

    <!-- Error Alert -->
    @if (errorMsg) {
      <div class="alert alert-danger alert-dismissible fade show rounded-3 shadow-sm" role="alert">
        <strong>Error:</strong> {{ errorMsg }}
        <button type="button" class="btn-close" (click)="errorMsg = null" aria-label="Close"></button>
      </div>
    }

    <!-- Results -->
    @if (submitted && !loading) {
      <div class="oms-card">
        <div class="oms-card-header d-flex justify-content-between align-items-center">
          <span>üìã Results</span>
          <span class="badge rounded-pill bg-white text-primary border border-primary px-3">{{ results.length }} record(s)</span>
        </div>

        @if (results.length === 0) {
          <div class="oms-card-body text-center py-5">
            <div class="display-4 mb-3">üîé</div>
            <h5 class="text-muted">No records found</h5>
            <p class="text-muted small">Try adjusting your filters and search again.</p>
          </div>
        } @else {
          <div class="table-responsive">
            <table class="table oms-table mb-0 align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th class="th-sortable" (click)="sortBy('orderNumber')" [class.th-sorted]="sortField==='orderNumber'">Order # <span class="sort-icon">{{ sortField==='orderNumber' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable" (click)="sortBy('patientName')" [class.th-sorted]="sortField==='patientName'">Patient <span class="sort-icon">{{ sortField==='patientName' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable" (click)="sortBy('mrn')" [class.th-sorted]="sortField==='mrn'">MRN <span class="sort-icon">{{ sortField==='mrn' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable" (click)="sortBy('drugName')" [class.th-sorted]="sortField==='drugName'">Drug <span class="sort-icon">{{ sortField==='drugName' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable" (click)="sortBy('dos')" [class.th-sorted]="sortField==='dos'">DOS <span class="sort-icon">{{ sortField==='dos' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable" (click)="sortBy('estimatedDeliveryDate')" [class.th-sorted]="sortField==='estimatedDeliveryDate'">Est. Delivery <span class="sort-icon">{{ sortField==='estimatedDeliveryDate' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable" (click)="sortBy('insuranceName')" [class.th-sorted]="sortField==='insuranceName'">Insurance <span class="sort-icon">{{ sortField==='insuranceName' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable" (click)="sortBy('currentTaskCode')" [class.th-sorted]="sortField==='currentTaskCode'">Task <span class="sort-icon">{{ sortField==='currentTaskCode' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable text-end" (click)="sortBy('totalUnitsBilled')" [class.th-sorted]="sortField==='totalUnitsBilled'">Units <span class="sort-icon">{{ sortField==='totalUnitsBilled' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable text-end" (click)="sortBy('totalAmountBilled')" [class.th-sorted]="sortField==='totalAmountBilled'">Billed <span class="sort-icon">{{ sortField==='totalAmountBilled' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable text-end" (click)="sortBy('totalPayments')" [class.th-sorted]="sortField==='totalPayments'">Payments <span class="sort-icon">{{ sortField==='totalPayments' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable text-end" (click)="sortBy('totalBalance')" [class.th-sorted]="sortField==='totalBalance'">Balance <span class="sort-icon">{{ sortField==='totalBalance' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                  <th class="th-sortable text-center" (click)="sortBy('isBilled')" [class.th-sorted]="sortField==='isBilled'">Billed? <span class="sort-icon">{{ sortField==='isBilled' ? (sortDir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ' }}</span></th>
                </tr>
              </thead>
              <tbody>
                @for (row of sortedResults; track row.orderId; let i = $index) {
                  <tr>
                    <td class="text-muted small">{{ i + 1 }}</td>
                    <td><span class="fw-semibold text-primary">{{ row.orderNumber ?? '‚Äî' }}</span></td>
                    <td class="fw-semibold">{{ row.patientName ?? '‚Äî' }}</td>
                    <td><span class="badge text-bg-light text-dark border">{{ row.mrn ?? '‚Äî' }}</span></td>
                    <td>{{ row.drugName ?? '‚Äî' }}</td>
                    <td class="small text-muted">{{ row.dos ? (row.dos | date:'MM/dd/yyyy') : '‚Äî' }}</td>
                    <td class="small text-muted">{{ row.estimatedDeliveryDate ? (row.estimatedDeliveryDate | date:'MM/dd/yyyy') : '‚Äî' }}</td>
                    <td class="small">{{ row.insuranceName ?? '‚Äî' }}</td>
                    <td>
                      @if (row.currentTaskCode) {
                        <span class="badge text-bg-info rounded-pill">{{ row.currentTaskCode }}</span>
                      } @else {
                        <span class="text-muted">‚Äî</span>
                      }
                    </td>
                    <td class="text-end">{{ row.totalUnitsBilled ?? 0 }}</td>
                    <td class="text-end">{{ row.totalAmountBilled | currency }}</td>
                    <td class="text-end text-success fw-semibold">{{ row.totalPayments | currency }}</td>
                    <td class="text-end fw-semibold"
                        [class.text-danger]="(row.totalBalance ?? 0) > 0"
                        [class.text-success]="(row.totalBalance ?? 0) <= 0">
                      {{ row.totalBalance | currency }}
                    </td>
                    <td class="text-center">
                      @if (row.isBilled) {
                        <span class="badge text-bg-success rounded-pill">‚úì Yes</span>
                      } @else {
                        <span class="badge text-bg-secondary rounded-pill">No</span>
                      }
                    </td>
                  </tr>
                }
              </tbody>
              <tfoot>
                <tr class="table-totals-row">
                  <td colspan="10" class="text-end fw-bold text-muted">Totals</td>
                  <td class="text-end fw-bold">{{ totalAmountBilled | currency }}</td>
                  <td class="text-end fw-bold text-success">{{ totalPayments | currency }}</td>
                  <td class="text-end fw-bold" [class.text-danger]="totalBalance > 0" [class.text-success]="totalBalance <= 0">{{ totalBalance | currency }}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        }
      </div>
    }

  </main>
</div>
